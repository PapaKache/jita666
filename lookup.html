<!DOCTYPE HTML>
<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<head>
<script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
<!--<script type="text/javascript" src="js/jquery-1.5.js"></script> -->
<script type="text/javascript" src="js/freeze-head.js"></script>

<style type="text/css">
#div1 {width:1; height:64;padding:10px;border:1px solid #aaaaaa;display: inline-block;}
.chord_cell {height:64px;border:1px solid #aaaaaa;}
#chord_cell_name {border:1px solid #aaaaaa;}
.title-margin-center{
                width: 100%;
                height: 70px;
                text-align: center;
                line-height: 100px;
}
#left-li{
	float:left;
	width:16%;
	};

#right-li{
	float:right;
	margin:12px;
	};

#href-black{
	color:"#000";
	};
a:link{color:red;}
a:visited{color:black;}

</style>

</head>
<body>
<!--<nav style="background-color:#EFEFEF;width:100%;height:50px;margin-top:0px">
-->

					<div style="width:100%">
						<div id="left-li"><img src='chord_image/logo.jpg' style="width:50px;height:50px"></div>
						<div id="left-li"><a href="list.html">曲谱列表</a></div>
						<div id="left-li"><a href="index.html">曲谱编辑</a></div>
						<div id="left-li"><a href="index.html">曲谱编辑教程</a></div>
						<div id="left-li"><a href="index.html">关于我们</a></div>
						<div id="left-li"><a href="index.html">用户</a></div>
			
					</div>
					


<!-- title -->
<div><input class="title-margin-center" value="音乐名称" id = 'music_title'> </input></div>
<div>
	<bdo dir="ltr">音调</bdo>
	<select id = "music_key" disabled="disabled">
		<option value ="C">C调</option>
		<option value ="D">D调</option>
		<option value="E">E调</option>
		<option value="F">F调</option>
	</select>
</div>

<div>
	<bdo dir="ltr">节拍</bdo>
	<select id='beat_time ' disabled="disabled">
		<option value ="4/4">4/4</option>
		<option value ="3/4">3/4</option>
		<option value="2/4">2/4</option>
		<option value="6/8">6/8</option>
	</select>
</div>


<div>
	<bdo dir="ltr">速度</bdo>
	<input id="music_speed" value="70" readonly="readonly"></input>
</div>
<div>
	<bdo dir="ltr">作者</bdo>
	<input id="music_author" value="佚名" readonly="readonly"></input>
</div>
<div>
	<bdo dir="ltr">备注</bdo>
	<input id="music_verbose" value="无" readonly="readonly"></input>
</div>


<!-- main-->
<div> <bdo dir="ltr">和弦示意图</bdo></div>
<table id="table_chord" border = "1px" width="100%" height="100%" style="table-layout:fixed">
<!--
	<thead>
		<tr><th style="background-color: #F5E9A3">&nbsp;</th><th>Heading 2</th><th>Heading 3</th><th>Heading 4</th></tr>
	</thead>
-->
	<thead>
	<tr>
		<th id="chord_cell_name"> <select id = 'chord_src1'  onchange="gradeChange(this.options[this.options.selectedIndex].text,1)" ></select></th>
		<td id="chord_cell_name"> <select id = 'chord_src2'  onchange="gradeChange(this.options[this.options.selectedIndex].text,2)" ></select></td>
		<td id="chord_cell_name"> <select id = 'chord_src3'  onchange="gradeChange(this.options[this.options.selectedIndex].text,3)" ></select></td>
		<td id="chord_cell_name"> <select id = 'chord_src4'  onchange="gradeChange(this.options[this.options.selectedIndex].text,4)" ></select></td>
		<td id="chord_cell_name"> <select id = 'chord_src5'  onchange="gradeChange(this.options[this.options.selectedIndex].text,5)" ></select></td>
		<td id="chord_cell_name"> <select id = 'chord_src6'  onchange="gradeChange(this.options[this.options.selectedIndex].text,6)" ></select></td>
		<td id="chord_cell_name"> <select id = 'chord_src7'  onchange="gradeChange(this.options[this.options.selectedIndex].text,7)" ></select></td>
		<td id="chord_cell_name"> <select id = 'chord_src8'  onchange="gradeChange(this.options[this.options.selectedIndex].text,8)" ></select></td>
		<td id="chord_cell_name"> <select id = 'chord_src9'  onchange="gradeChange(this.options[this.options.selectedIndex].text,9)" ></select></td>
		<td id="chord_cell_name"> <select id = 'chord_src10'  onchange="gradeChange(this.options[this.options.selectedIndex].text,10)" ></select></td>
		<td id="chord_cell_name"> <select id = 'chord_src11'  onchange="gradeChange(this.options[this.options.selectedIndex].text,11)" ></select></td>
		<td id="chord_cell_name"> <select id = 'chord_src12'  onchange="gradeChange(this.options[this.options.selectedIndex].text,12)" ></select></td>
	</tr>
	
	<tr >
		<th id="chord_cell"><img id="chord_drag1" draggable="true" ondragstart="drag(event)" /></th>
		<th id="chord_cell"><img id="chord_drag2" draggable="true" ondragstart="drag(event)" /></th>
		<th id="chord_cell"><img id="chord_drag3" draggable="true" ondragstart="drag(event)" /></th>
		<th id="chord_cell"><img id="chord_drag4" draggable="true" ondragstart="drag(event)" /></th>
		<th id="chord_cell"><img id="chord_drag5" draggable="true" ondragstart="drag(event)" /></th>
		<th id="chord_cell"><img id="chord_drag6" draggable="true" ondragstart="drag(event)" /></th>
		<th id="chord_cell"><img id="chord_drag7" draggable="true" ondragstart="drag(event)" /></th>
		<th id="chord_cell"><img id="chord_drag8" draggable="true" ondragstart="drag(event)" /></th>
		<th id="chord_cell"><img id="chord_drag9" draggable="true" ondragstart="drag(event)" /></th>
		<th id="chord_cell"><img id="chord_drag10" draggable="true" ondragstart="drag(event)" /></th>
		<th id="chord_cell"><img id="chord_drag11" draggable="true" ondragstart="drag(event)" /></th>
		<th id="chord_cell"><img id="chord_drag12" draggable="true" ondragstart="drag(event)" /></th>
	</tr>
	<!--<tr><td colspan='12'><input style="width:99%; height: 100%" value="乐谱(从下面开始编辑)"></input></td></tr> -->
	<tr><td colspan='12'><p style="width:99%; height: 100%">乐谱(从下面开始编辑)</p></td></tr>
	</thead>
</table>

<hr border='1px'/>
<div>
	<bdo dir="ltr">歌词字体大小</bdo>
	<input id="lyric_size" type="range" min="10" max="50" value="12" onchange="change_lyric_font_size()">
</div>
<input type='file' id="load_music_file" onchange="load_file()">载入</button>
<!-- main end-->

<!--
<img id="drag1" src="c.png" draggable="true" ondragstart="drag(event)" />
<img id="drag2" src="d.png" draggable="true" ondragstart="drag(event)" />
-->
</body>

<script type="text/javascript">
key_list = ["","C","D","E","F","G","A","B","Cm","Dm","Em","Fm","Gm","Am","Bm"];
default_key_c_list = ["C","Am","F","G", "F", "Em"];
g_row_index = -1;
g_lyric_font_size = '12px';

function  onclick_fast_load_lyric()
{
	document.getElementById("button_fast_load_lyric").style.display="none";
	div = document.getElementById("div_fast_load_lyric");
	div.style.display = "block";
}

function onclick_fast_load_lyric_confirm()
{
	document.getElementById("button_fast_load_lyric").style.display="block";
	div = document.getElementById("div_fast_load_lyric");
	div.style.display = "none";
	
	lyrics = document.getElementById("lyric_load_values").value;
	//console.log("thie vlaues:" + values);
	lyrics = lyrics.replace("\r\n","\n");
	//console.log(lyrics);
	lyric_array = lyrics.split('\n');
	console.log(lyric_array);

	if (lyric_array.length <= 1)
		return;
	while(del_line() == 0)
	{
		sleep(10);
	}
	var sel_beat_time_id = document.getElementById('beat_time');
	var beat_time = sel_beat_time_id.value;
	var line_number_lyric = 3;
	
	if (beat_time == "4/4")
	{
		line_number_lyric = 3;
	}
	else if (beat_time == "3/4")
	{
		line_number_lyric = 4;
	}
	else
	{
		line_number_lyric = 6;
	}
	var line_number = parseInt(lyric_array.length/line_number_lyric);
	console.log('line number:' + line_number);
	while(line_number)
	{
		line_number = line_number - 1;
		add_line()
	};
	for (var i = 1; i <= lyric_array.length;i++)
	{
		lyric = lyric_array[i - 1];
		key = 'main_lyric' + i;
		td = document.getElementById(key);
			
		if (td.children[0] != undefined)
		{
			td.children[0].value = lyric;
			
		}
	}

}

function get_table_values()
{
	var tb = document.getElementById('table_chord');
}

function change_lyric_font_size()
{
	var size = document.getElementById('lyric_size').value;
	g_lyric_font_size = size + 'px';
	var sel_beat_time_id = document.getElementById('beat_time');
	var beat_time = sel_beat_time_id.value;
	console.log('font size change:' + size);
	var cnt;
	if (beat_time == "4/4")
	{
		cnt = (g_row_index + 1)/2 * 3;
	}
	else if (beat_time == "3/4")
	{
		cnt = (g_row_index + 1)/2 * 4;
	}
	else
	{
		cnt = (g_row_index + 1)/2 * 6;
	}

	for (var i = 1; i <= cnt; i++)
	{
		key = 'main_lyric' + i;
		item = document.getElementById(key);
		console.log(item.children[0]);
		/*check td child input*/
		if (item.children[0] != null)
		{
			item.children[0].style.fontSize = size + "px";
		}
	}
	
	
}

function del_line()
{
	if (g_row_index < 0)
		return -1;
	//console.log(g_row_index);
	var tb = document.getElementById('table_chord');
	tb.rows[g_row_index +  3].remove();
	tb.rows[g_row_index - 1 + 3].remove();
	g_row_index -= 2;
	return 0;
}

function add_line()
{
	var tb = document.getElementById('table_chord');
	var tbb = tb.getElementsByTagName("tbody");
	console.log("add line");
	g_row_index += 2;
		
	var sel_beat_time_id = document.getElementById('beat_time');
	//bt = sel_beat_time_id.selectedIndex;
	beat_time = sel_beat_time_id.value;
	//console.log(bt);

	s = "<tr>";
	for(var i = 0; i < 12; i++)
	{
		index = i + (g_row_index - 1)/2 * 12 + 1;
		s += "<td" + " id = main_chord" + index + " class='chord_cell' ondrop='drop(event)' ondragover='allowDrop(event)' onclick='on_click_clear_single(this)'> </td>";
	}
	s += "</tr>";

	if (beat_time == "4/4")
	{
		s += "<tr>";
		for(var i = 0; i < 3; i++)
		{
			index = i + (g_row_index - 1)/2 * 3 + 1;
			style="'width:96%;height:100%;" +  "font-size:" + g_lyric_font_size + "'";
			s += "<td" + " id = main_lyric" + index;
			s += " colspan='4'>";
			s += '<input style=' + style;
			s += " ></input></td>";
		}
		s += "</tr>";

	}

	else if (beat_time == "3/4")
	{
		s += "<tr>";
		for(var i = 0; i < 4; i++)
		{
			index = i + (g_row_index - 1)/2 * 4 + 1;
			style="'width:95%;height:100%;" +  "font-size:" + g_lyric_font_size + "'";
			s += "<td" + " id = main_lyric" + index;
			s += " colspan='3'>";
			s += '<input style=' + style;
			s += " ></input></td>";
		}
		s += "</tr>";

	}
	else
	{
		s += "<tr>";
		for(var i = 0; i < 6; i++)
		{
			index = i + (g_row_index - 1)/2 * 6 + 1;
			style="'width:94%;height:100%;" +  "font-size:" + g_lyric_font_size + "'";
			s += "<td" + " id = main_lyric" + index;
			s += " colspan='2'>";
			s += '<input style=' + style;
			s += " ></input></td>";
		}
		s += "</tr>";

	}
	$('#table_chord').append(s);
	console.log(tbb);
}

function allowDrop(ev)
{
	ev.preventDefault();
}

function drag(ev)
{
	ev.dataTransfer.setData("Text",ev.target.id);
}

function drop(ev)
{
	ev.preventDefault();
	var data=ev.dataTransfer.getData("Text");
	//console.log(ev)
	target = ev.target;
	if (target.tagName != "TD")
	{
		target = target.parentNode;
	}
	//console.log(target);
	//console.log(target.parentNode);
	//console.log(data);
	item = document.getElementById(data);
	var img_node = document.createElement('img');
	//img_node.innerHTML=item.innerHTML;
	console.log(data);
	//console.log(item.innerHTML);
	img_node.src = item.src;
	let lists=target.getElementsByTagName("img");
	if (lists.length > 0)
    {
		for (var i = 0; i < lists.length; i++)
			target.removeChild(lists[i]);
    }
    target.appendChild(img_node);
}

function on_click_clear_single(target)
{
	console.log(typeof target);
	console.log(target);
	if (target.tagName != "TD")
	{
		target = target.parentNode;
	}
	let lists=target.getElementsByTagName("img");
    //console.log(lists) ;
	if (lists.length > 0)
    {
		for (var i = 0; i < lists.length; i++)
			target.removeChild(lists[i]);
    }
}
function gradeChange(tx,index)
{
	//alert(tx + index);
	drag_key = "chord_drag" + index;
	//this.options[this.options.selectedIndex].text;
	var item = document.getElementById(drag_key);
	key = tx;
	img = get_key_image(key);
	//alert(img);
	if (tx != "")
		item.src = img;
	else
		item.src ="";
}
function init(default_key)
{
	lists = key_list;
	for(var i = 1;i<= 12;i++)
	{
		key = "chord_src" + i;
		var selid = document.getElementById(key);
		while (selid.firstChild) {
			selid.removeChild(selid.firstChild);
		}

		for(var j = 0;j< lists.length;j++)
			selid.add(new Option(lists[j],j),lists[j]);
			
			
		
		if ((i - 1) < default_key.length)
		{
			drag_key = "chord_drag" + i;
			//console.log(drag_key);
			var image_item = document.getElementById(drag_key);
			key = default_key[i - 1];
			if (key == "")
				continue;
			img = get_key_image(key);
			image_item.src = img;
			select_key_index = get_key_index(key);
			//console.log(select_key_index);
			selid.value = select_key_index;
		}
   	 }
	
}

function get_key_index(key)
{
	for(var j = 0;j< lists.length;j++)
		if (key == lists[j])
			return j;
	return -1;
}

function get_key_image(key)
{
	return "chord_image/" + key + ".jpg";
}

function sleep(n) 
{
        var start = new Date().getTime();
        while (true) {
            if (new Date().getTime() - start > n) {
                break;
            }
        }
}

function music_save()
{
	var title = document.getElementById('music_title').value;
	var key = document.getElementById('music_key').value;
	var beat_time = document.getElementById('beat_time').value;
	var speed = document.getElementById('music_speed').value;
	var author = document.getElementById('music_author').value;
	var verbose = document.getElementById('music_verbose').value;
	/*flag*/
	var s= 'gtp singer' + '\n';
	s += title + "\n";
	s += key + "\n";
	s += beat_time + "\n";
	s += speed + "\n";
	s += author + "\n";
	s += verbose + "\n";
	s += g_row_index + "\n";
	s += g_lyric_font_size + "\n";
	/*chord source*/
	for (var i = 1; i <= 12; i++)
	{	
		key = 'chord_src' + i;
		var selid = document.getElementById(key);
		var options = selid.options;
		var index = selid.selectedIndex;
		var value = options[index].text;
		if (value == "")
			value = "flag-blank-chord-source";
		s += value + "\n";

	}

	var line_number = (g_row_index + 1)/2;
	var chord_max_index = line_number * 12;
	var lyric_max_index = 0;
	console.log('line num:' + line_number);

	if (beat_time == "4/4")
	{
		lyric_max_index = line_number * 3; 
	}

	else if (beat_time == "3/4")
	{
		lyric_max_index = line_number * 4;

	}
	else
	{
		lyric_max_index = line_number * 6;

	}
	for (var i = 1; i <= chord_max_index;i++)
	{
		key = 'main_chord' + i;
		item = document.getElementById(key);
		if (item.children[0] != undefined)
		{
			msg = item.children[0].outerHTML;
			var start = msg.lastIndexOf("/");
			var end = msg.lastIndexOf(".");
			var len = end - start - 1;
			console.log(msg.substr(start + 1,len));
			s += msg.substr(start + 1,len) + '\n';
		}
		else
		{
			s += 'flag-blank-chord' + '\n';
		}
	}
	for (var i = 1; i <= lyric_max_index;i++)
	{
		key = 'main_lyric' + i;
		item = document.getElementById(key);
		if (item.children[0] != undefined)
		{
			lyric = item.children[0].value;
			if (lyric != "")
			{
				console.log(lyric);
				s += lyric + "\n";
			}
			else
			{
				s+= 'flag-blank-lyric' + '\n';
			}
		}
		else
		{
			//s += 'blank' + '\n';
		}
	}


	console.log(s);
	save_file('tmp.txt',s);
	//chord_src1
}

function save_file(name, data) {
	var urlObject = window.URL || window.webkitURL || window;
	var export_blob = new Blob([data]);
	var save_link = document.createElementNS("http://www.w3.org/1999/xhtml", "a")
	save_link.href = urlObject.createObjectURL(export_blob);
	save_link.download = name;

	var ev = document.createEvent("MouseEvents");
   	ev.initMouseEvent("click", true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
   	save_link.dispatchEvent(ev);
}
 
function load_file()
{
	var file=document.getElementById("load_music_file");
        var reader=new FileReader();
	//console.log(file);
	//console.log(file.files[0]);
	reader.readAsText(file.files[0]);
	
	reader.onload=function(e)
	{
		//console.log(e.target.result);
		/*clear all main chord*/
		while(del_line() == 0)
		{
			sleep(10);
		}
		vs = e.target.result.split('\n');
		console.log(vs);
		flag= vs[0];
		title = vs[1];
		key = vs[2];
		beat_time = vs[3];
		speed = vs[4];
		author = vs[5];
		verbose = vs[6];
		row_index = parseInt(vs[7]);
		g_lyric_font_size = vs[8];

		document.getElementById('music_title').value = title;
		document.getElementById('music_key').value = key;
		document.getElementById('beat_time').value = beat_time;
		document.getElementById('music_speed').value = speed;
		document.getElementById('music_author').value = author;
		document.getElementById('music_verbose').value = verbose;
	
		console.log(row_index);
		var line_number = (row_index + 1)/2;
		var chord_max_index = line_number * 12;
		var lyric_max_index = 0;
		console.log('line num:' + line_number);

		if (beat_time == "4/4")
		{
			lyric_max_index = line_number * 3; 
		}

		else if (beat_time == "3/4")
		{
			lyric_max_index = line_number * 4;
	
		}
		else
		{
			lyric_max_index = line_number * 6;
	
		}
		var chord_list = ["","","","","","","","","","","",""];
		for (var i = 0; i < 12; i++)
		{
			chord = vs[9 + i];
			
			if (chord != "flag-blank-chord-source") 
			{
				chord_list[i] = chord;
				console.log('chord src:' + chord);
			}
		}
		
		init(chord_list);
		for (var i = 0; i < line_number;i++)
		{
			add_line();
		}
		for (var i = 1; i <= chord_max_index;i++)
		{
			key = 'main_chord' + i;
			td = document.getElementById(key);
			chord = vs[12 + 9 + i - 1];
			console.log(chord);
			if (chord != 'flag-blank-chord')
			{
				var img_node = document.createElement('img');
				img_src = get_key_image(chord);
				img_node.src = img_src;
				let lists=td.getElementsByTagName("img");
				if (lists.length > 0)
    				{
					for (var i = 0; i < lists.length; i++)
						td.removeChild(lists[i]);
    				}
   				td.appendChild(img_node);
			}
	
		}
		for (var i = 1; i <= lyric_max_index;i++)
		{
			lyric = vs[12 + 9 + chord_max_index + i - 1];
			key = 'main_lyric' + i;
			td = document.getElementById(key);
			
			if (td.children[0] != undefined)
			{
				if (lyric != 'flag-blank-lyric')
				{
					td.children[0].value = lyric;
				}
			
			}
		}
		
        };
	
}

init(default_key_c_list);
console.log(window.location.href);

//save_file('tmp','abcdefdfadsf');
</script>
</html>
